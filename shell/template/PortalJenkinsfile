pipeline {
    agent any
    environment {
        HOME = "${env.WORKSPACE}"
        env_shell="play"
        source_mount="/volume1/docker-data/erp_play_portal"
    }
    stages {
        stage('init') {
            steps {
                sh 'pip3 install -r script/requirements.txt && \
                    python3 script/run.py \
                    --env shell/${env_shell}/_env.py \
                    --init \
                    --log-file init.log \
                    --param param_api_image=erp_portal:play \
                            param_api_module_name=portal \
                            param_api_config_path=${source_mount}/config \
                            param_api_data_path=${source_mount}/data \
                            param_api_log_path=${source_mount}/log'
            }
        }
        stage('build_api') {
            steps {
                sh 'python3 script/run.py \
                    --env shell/${env_shell}/_env.py \
                    --log-file build_api.log \
                    --cmd \'from script.domain.source import base as base_source,java as java_source;java_source.build_api();base_source.build_template_dict();\''
            }
        }
        stage('deploy') {
            steps {
                sh 'python3 script/run.py \
                    --env shell/${env_shell}/_env.py \
                    --log-file deploy.log \
                    --cmd \'from script.domain.source import base as base_source,java as java_source;base_source.down_container();java_source.copy_config();base_source.start_api_compose()\''
            }
        }
    }
}
