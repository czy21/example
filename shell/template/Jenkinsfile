pipeline {
    agent any
    stages {
        stage('init') {
            steps{
                sh 'pip3 install -r script/requirements.txt'
            }
        }
        stage('build') {
            environment {
                HOME = "${env.WORKSPACE}"
            }
            steps{
                parallel(
                    db:{
                        sh 'sh shell/play/rebuild_rdb.sh'
                    },
                    api:{
                        sh 'sh shell/play/build_api_image.sh --param param_api_image_tag=play'
                    }
                )
            }
        }
        stage('deploy') {
            steps{
                sh 'sh shell/play/start_api.sh --param param_api_image_tag=play'
            }
        }
    }
}
