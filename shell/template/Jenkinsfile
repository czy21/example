pipeline {
    agent any
    environment {
        HOME = "${env.WORKSPACE}"
        env_shell="play"
        project_param='--param param_api_image=erp:play'
    }
    stages {
        stage('init') {
            steps {
                sh 'pip3 install -r script/requirements.txt && python3 shell/"${env_shell}"/init.sh ${project_param}'
            }
        }
        stage('build_db') {
            steps {
                sh 'python3 shell/"${env_shell}"/build_rdb.py ${project_param} --skip-rm-output'
            }
        }
        stage('build_api') {
            steps {
                sh 'python3 shell/"${env_shell}"/build_api.py ${project_param} --skip-rm-output'
            }
        }
        stage('build_web') {
            steps {
                sh 'echo "build_web"'
            }
        }
        stage('deploy_db'){
            steps{
                sh 'python3 shell/"${env_shell}"/recreate_rdb.py ${project_param} --skip-rm-output && \
                    python3 shell/"${env_shell}"/exec_rdb.py ${project_param} --skip-rm-output \
                    '
            }
        }
        stage('deploy_api'){
            steps{
                sh 'python3 shell/"${env_shell}"/start_api_compose.py ${project_param} --skip-rm-output'
            }
        }
    }
}
