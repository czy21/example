pipeline {
    agent any
    environment {
        HOME = "${env.WORKSPACE}"
        env_shell="play"
        project_param='--param param_api_image=erp:play'
    }
    stages {
        stage('init') {
            steps {
                sh 'pip3 install -r script/requirements.txt && \
                    python3 shell/run.py \
                    --env shell/${env_shell}/_env.py \
                    --log-file ensure_network.log \
                    ${project_param} \
                    --cmd \'from script.domain.source import java as java_source;java_source.ensure_network()\''
            }
        }
        stage('build') {
            failFast true
            parallel {
                stage('db') {
                    steps {
                        sh 'python3 shell/run.py \
                            --env shell/${env_shell}/_env.py \
                            --log-file build_db.log \
                            ${project_param} --skip-rm-output \
                            --cmd \'from script.domain.source import mysql as mysql_source;mysql_source.assemble()\''
                    }
                }
                stage('api') {
                    steps {
                        sh 'python3 shell/run.py \
                            --env shell/${env_shell}/_env.py \
                            --log-file build_api.log \
                            ${project_param} --skip-rm-output \
                            --cmd \'from script.domain.source import java as java_source;java_source.build_plugin();java_source.build_api()\''
                    }
                }
                stage('web') {
                    steps {
                        sh 'echo "build_web"'
                    }
                }
            }
        }
        stage('deploy') {
            steps {
                sh 'pip3 install -r script/requirements.txt && \
                    python3 shell/run.py \
                    --env shell/${env_shell}/_env.py \
                    --log-file deploy.log \
                    ${project_param} --skip-rm-output \
                    --cmd \'from script.domain.source import java as java_source,mysql as mysql_source;mysql_source.recreate();mysql_source.exec();java_source.start_api_compose()\''
            }
        }
    }
}
